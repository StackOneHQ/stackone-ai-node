name: Check OAS Updates

on:
  schedule:
    # Run at 00:00 UTC every weekday
    - cron: "0 0 * * 1-5"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-oas-updates:
    name: Check for OAS updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fetch latest OAS specs
        run: pnpm run fetch:specs

      - name: Check for OAS changes
        id: check-oas-changes
        run: |
          if [[ -n "$(git status --porcelain src/openapi/generated/)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "::notice::OAS changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No OAS changes detected"
          fi

      - name: Update test snapshots
        if: steps.check-oas-changes.outputs.changes == 'true'
        run: pnpm test -- -u

      - name: Verify changes work with the codebase
        if: steps.check-oas-changes.outputs.changes == 'true'
        run: |
          # Run tests to ensure the updated OAS files don't break anything
          pnpm test

          # Run linter to ensure code quality
          pnpm run lint

          # Verify the package builds correctly with the updated OAS files
          pnpm run build

      - name: Configure Git
        if: steps.check-oas-changes.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create Pull Request
        if: steps.check-oas-changes.outputs.changes == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update OAS specifications and test snapshots"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          title: "chore: update OAS specifications and test snapshots"
          body: |
            This PR updates the OpenAPI specifications to the latest version and regenerates test snapshots.

            Changes were automatically detected and committed by the GitHub Actions workflow.

            - [x] OAS files updated
            - [x] Test snapshots updated
            - [x] Verified changes work with the codebase (tests, lint, build)
          branch: auto-update-oas
          base: main
          delete-branch: true
          labels: |
            automated
            dependencies

      - name: PR Summary
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "::notice::Created PR #${{ steps.create-pr.outputs.pull-request-number }} with OAS updates"
          echo "::notice::PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
