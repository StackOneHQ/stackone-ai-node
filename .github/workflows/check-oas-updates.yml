name: Check OAS Updates

on:
  schedule:
    # Run at 00:00 UTC every weekday
    - cron: "0 0 * * 1-5"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-oas-updates:
    name: Check for OAS updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun ci

      - name: Fetch latest OAS specs
        run: bun run fetch:specs

      - name: Check for OAS changes
        id: check-oas-changes
        run: |
          if [[ -n "$(git status --porcelain src/openapi/generated/)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "::notice::OAS changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No OAS changes detected"
          fi

      - name: Verify changes work with the codebase
        if: steps.check-oas-changes.outputs.changes == 'true'
        run: |
          # Run tests to ensure the updated OAS files don't break anything
          bun test -u

          # Run linter to ensure code quality
          bun run lint

          # Verify the package builds correctly with the updated OAS files
          bun run build

      - name: Configure Git
        if: steps.check-oas-changes.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create Pull Request
        if: steps.check-oas-changes.outputs.changes == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update OAS specifications"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          title: "chore: update OAS specifications"
          body: |
            This PR updates the OpenAPI specifications to the latest version.

            Changes were automatically detected and committed by the GitHub Actions workflow.

            - [x] OAS files updated
            - [x] Verified changes work with the codebase (tests, lint, build)
          branch: auto-update-oas
          base: main
          delete-branch: true
          labels: |
            automated
            dependencies

      - name: PR Summary
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "::notice::Created PR #${{ steps.create-pr.outputs.pull-request-number }} with OAS updates"
          echo "::notice::PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
